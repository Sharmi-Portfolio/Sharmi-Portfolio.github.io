<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Sharmila Portfolio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff9d68;
            --primary-dark: #ff7a14;
            --dark: #121212;
            --dark-light: #1e1e1e;
            --light: #f5f5f7;
            --gray: #a0a0a0;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body {
            background-color: var(--dark);
            color: var(--light);
            padding-top: 80px;
            visibility: hidden; 
        }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; gap: 20px; }
        .loader { border: 5px solid var(--dark-light); border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        #loading-overlay p { color: var(--primary); font-weight: 500;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .admin-header { position: fixed; top: 0; left: 0; width: 100%; background: rgba(18, 18, 18, 0.95); backdrop-filter: blur(20px); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; z-index: 1000; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .admin-header h1 { font-size: 24px; color: var(--primary); }
        
        .admin-container { display: flex; min-height: calc(100vh - 80px); }
        .admin-sidebar { width: 250px; background: var(--dark-light); padding: 30px 0; border-right: 1px solid rgba(255, 255, 255, 0.05); }
        
        .admin-nav { list-style: none; padding: 0 20px; }
        .admin-nav a { display: flex; align-items: center; padding: 15px 20px; color: var(--light); text-decoration: none; border-radius: 8px; transition: all 0.3s ease; gap: 12px; }
        .admin-nav a:hover, .admin-nav a.active { background: rgba(255, 122, 77, 0.15); color: var(--primary); }
        
        .admin-main { flex: 1; padding: 30px; }
        
        .admin-card { background: var(--dark-light); border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .card-header h2 { font-size: 24px; }
        
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 10px; font-weight: 500; }
        .form-control { width: 100%; padding: 16px 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; color: var(--light); font-size: 16px; transition: all 0.3s ease; }
        .form-control:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(255, 122, 77, 0.2); }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 16px 32px; background: var(--primary); color: white; border-radius: 50px; font-weight: 600; font-size: 16px; border: none; cursor: pointer; transition: all 0.4s ease; gap: 10px; }
        .btn:hover { background: var(--primary-dark); transform: translateY(-3px); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: rgba(255, 122, 77, 0.15); }
        
        .projects-table, .users-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .projects-table th, .projects-table td, .users-table th, .users-table td { padding: 18px 15px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .projects-table th, .users-table th { color: var(--light); }
        
        .delete-btn:hover { background: rgba(229, 57, 53, 0.3); color: #e53935; }
        
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }

    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="loader"></div>
        <p>Verifying Admin Access...</p>
    </div>

    <div id="admin-content" style="width:100%; display: none;">
        <header class="admin-header">
            <h1><i class="fas fa-cog"></i> Admin Panel</h1>
            <button id="logout-btn" class="btn btn-outline"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </header>
        
        <div class="admin-container">
            <nav class="admin-sidebar">
                <ul class="admin-nav">
                    <li><a href="#projects-section" class="active"><i class="fas fa-project-diagram"></i> Projects</a></li>
                    <li><a href="#users-section"><i class="fas fa-users-cog"></i> User Roles</a></li>
                </ul>
            </nav>
            
            <main class="admin-main">
                <div class="admin-card" id="projects-section">
                    <div class="card-header"><h2>Add New Project</h2></div>
                    <form id="projectForm">
                        <div class="form-group"><label for="projectTitle">Project Title</label><input type="text" class="form-control" id="projectTitle" required></div>
                        <div class="form-group"><label for="projectCategory">Category</label><input type="text" class="form-control" id="projectCategory" required></div>
                        <div class="form-group"><label for="projectDescription">Description</label><textarea class="form-control" id="projectDescription" required></textarea></div>
                        <div class="form-group"><label for="projectImage">Image URL</label><input type="text" class="form-control" id="projectImage" required></div>
                        <div class="form-group"><button type="submit" class="btn"><i class="fas fa-plus-circle"></i> Add Project</button></div>
                    </form>
                </div>
                
                <div class="admin-card">
                    <div class="card-header"><h2>Manage Projects</h2></div>
                    <table class="projects-table">
                        <thead><tr><th>Project</th><th>Category</th><th>Actions</th></tr></thead>
                        <tbody id="projects-table-body"></tbody>
                    </table>
                </div>

                 <div class="admin-card" id="users-section">
                    <div class="card-header"><h2>User Management</h2></div>
                    <table class="users-table">
                        <thead><tr><th>User Email</th><th>Is Admin?</th></tr></thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, onSnapshot, addDoc, deleteDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCpna5VEjHLHg6YLG6LdDYiPpZXjjPdlcY",
            authDomain: "sharmila-portfolio.firebaseapp.com",
            projectId: "sharmila-portfolio",
            storageBucket: "sharmila-portfolio.firebasestorage.app",
            messagingSenderId: "316701396353",
            appId: "1:316701396353:web:1244d0d7cf71d409292c80",
            measurementId: "G-8Z60TQP834"
        };
        
        const loadingOverlay = document.getElementById('loading-overlay');
        const adminContent = document.getElementById('admin-content');
        const body = document.querySelector('body');
        const logoutBtn = document.getElementById('logout-btn');
        const projectForm = document.getElementById('projectForm');
        const projectsTableBody = document.getElementById('projects-table-body');
        const usersTableBody = document.getElementById('users-table-body');

        try {
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "AIzaSyCpna5VEjHLHg6YLG6LdDYiPpZXjjPdlcY") {
                throw new Error("Firebase configuration is missing.");
            }
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userDocRef = doc(db, "users", user.uid);
                    let userDoc = await getDoc(userDocRef);

                    // If the logged-in user is the super admin and their doc doesn't exist, create it.
                    if (user.email === 'samsurya561@gmail.com' && !userDoc.exists()) {
                        try {
                            await setDoc(userDocRef, {
                                email: user.email,
                                isAdmin: true
                            });
                            // Re-fetch the doc to confirm creation
                            userDoc = await getDoc(userDocRef);
                            console.log("Super admin document created automatically.");
                        } catch (e) {
                            console.error("Error creating super admin document:", e);
                            window.location.href = './login.html'; // Redirect if doc creation fails
                            return;
                        }
                    }

                    if (userDoc.exists() && userDoc.data().isAdmin) {
                        loadingOverlay.style.display = 'none';
                        adminContent.style.display = 'block';
                        body.style.visibility = 'visible';
                        loadProjects(db);
                        loadUsers(db);
                    } else {
                        window.location.href = './login.html';
                    }
                } else {
                    window.location.href = './login.html';
                }
            });

            logoutBtn.addEventListener('click', async () => {
                await signOut(auth);
                window.location.href = './login.html';
            });

            projectForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await addDoc(collection(db, "projects"), {
                    title: document.getElementById('projectTitle').value,
                    category: document.getElementById('projectCategory').value,
                    description: document.getElementById('projectDescription').value,
                    imageUrl: document.getElementById('projectImage').value,
                });
                projectForm.reset();
            });
        
            function loadProjects(db) {
                onSnapshot(collection(db, "projects"), (snapshot) => {
                    projectsTableBody.innerHTML = '';
                    snapshot.forEach((doc) => {
                        const project = doc.data();
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${project.title}</td>
                            <td>${project.category}</td>
                            <td><button class="btn-outline delete-btn" data-id="${doc.id}"><i class="fas fa-trash"></i></button></td>`;
                        projectsTableBody.appendChild(row);
                    });
                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const id = e.currentTarget.dataset.id;
                            if (confirm('Delete this project?')) {
                                await deleteDoc(doc(db, "projects", id));
                            }
                        });
                    });
                });
            }

            function loadUsers(db) {
                onSnapshot(collection(db, "users"), (snapshot) => {
                    usersTableBody.innerHTML = '';
                    snapshot.forEach((doc) => {
                        const user = doc.data();
                        const row = document.createElement('tr');
                        const isSuperAdmin = user.email === 'samsurya561@gmail.com';
                        row.innerHTML = `
                            <td>${user.email} ${isSuperAdmin ? '(Super Admin)' : ''}</td>
                            <td>
                                <label class="switch">
                                    <input type="checkbox" class="admin-toggle" data-id="${doc.id}" ${user.isAdmin ? 'checked' : ''} ${isSuperAdmin ? 'disabled' : ''}>
                                    <span class="slider"></span>
                                </label>
                            </td>`;
                        usersTableBody.appendChild(row);
                    });
                    document.querySelectorAll('.admin-toggle').forEach(toggle => {
                        toggle.addEventListener('change', async (e) => {
                            const id = e.currentTarget.dataset.id;
                            await updateDoc(doc(db, "users", id), { isAdmin: e.currentTarget.checked });
                        });
                    });
                });
            }

        } catch (error) {
            loadingOverlay.innerHTML = `<p style="color: var(--danger);">${error.message}</p>`;
        }
    </script>
</body>
</html>
